var X=Object.defineProperty;var T=t=>{throw TypeError(t)};var F=(t,e,n)=>e in t?X(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var E=(t,e,n)=>F(t,typeof e!="symbol"?e+"":e,n),B=(t,e,n)=>e.has(t)||T("Cannot "+n);var o=(t,e,n)=>(B(t,e,"read from private field"),n?n.call(t):e.get(t)),w=(t,e,n)=>e.has(t)?T("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,n),A=(t,e,n,r)=>(B(t,e,"write to private field"),r?r.call(t,n):e.set(t,n),n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function n(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(i){if(i.ep)return;i.ep=!0;const a=n(i);fetch(i.href,a)}})();var c;(function(t){t.LOAD="LOAD",t.EXEC="EXEC",t.FFPROBE="FFPROBE",t.WRITE_FILE="WRITE_FILE",t.READ_FILE="READ_FILE",t.DELETE_FILE="DELETE_FILE",t.RENAME="RENAME",t.CREATE_DIR="CREATE_DIR",t.LIST_DIR="LIST_DIR",t.DELETE_DIR="DELETE_DIR",t.ERROR="ERROR",t.DOWNLOAD="DOWNLOAD",t.PROGRESS="PROGRESS",t.LOG="LOG",t.MOUNT="MOUNT",t.UNMOUNT="UNMOUNT"})(c||(c={}));const v=(()=>{let t=0;return()=>t++})(),M=new Error("ffmpeg is not loaded, call `await ffmpeg.load()` first"),G=new Error("called FFmpeg.terminate()");var R,I,m,D,O,y,u;class ${constructor(){w(this,R,null);w(this,I,{});w(this,m,{});w(this,D,[]);w(this,O,[]);E(this,"loaded",!1);w(this,y,()=>{o(this,R)&&(o(this,R).onmessage=({data:{id:e,type:n,data:r}})=>{switch(n){case c.LOAD:this.loaded=!0,o(this,I)[e](r);break;case c.MOUNT:case c.UNMOUNT:case c.EXEC:case c.FFPROBE:case c.WRITE_FILE:case c.READ_FILE:case c.DELETE_FILE:case c.RENAME:case c.CREATE_DIR:case c.LIST_DIR:case c.DELETE_DIR:o(this,I)[e](r);break;case c.LOG:o(this,D).forEach(i=>i(r));break;case c.PROGRESS:o(this,O).forEach(i=>i(r));break;case c.ERROR:o(this,m)[e](r);break}delete o(this,I)[e],delete o(this,m)[e]})});w(this,u,({type:e,data:n},r=[],i)=>o(this,R)?new Promise((a,s)=>{const d=v();o(this,R)&&o(this,R).postMessage({id:d,type:e,data:n},r),o(this,I)[d]=a,o(this,m)[d]=s,i==null||i.addEventListener("abort",()=>{s(new DOMException(`Message # ${d} was aborted`,"AbortError"))},{once:!0})}):Promise.reject(M));E(this,"load",({classWorkerURL:e,...n}={},{signal:r}={})=>(o(this,R)||(A(this,R,e?new Worker(new URL(e,import.meta.url),{type:"module"}):new Worker(new URL("./worker-BAOIWoxA.js",import.meta.url),{type:"module"})),o(this,y).call(this)),o(this,u).call(this,{type:c.LOAD,data:n},void 0,r)));E(this,"exec",(e,n=-1,{signal:r}={})=>o(this,u).call(this,{type:c.EXEC,data:{args:e,timeout:n}},void 0,r));E(this,"ffprobe",(e,n=-1,{signal:r}={})=>o(this,u).call(this,{type:c.FFPROBE,data:{args:e,timeout:n}},void 0,r));E(this,"terminate",()=>{const e=Object.keys(o(this,m));for(const n of e)o(this,m)[n](G),delete o(this,m)[n],delete o(this,I)[n];o(this,R)&&(o(this,R).terminate(),A(this,R,null),this.loaded=!1)});E(this,"writeFile",(e,n,{signal:r}={})=>{const i=[];return n instanceof Uint8Array&&i.push(n.buffer),o(this,u).call(this,{type:c.WRITE_FILE,data:{path:e,data:n}},i,r)});E(this,"mount",(e,n,r)=>{const i=[];return o(this,u).call(this,{type:c.MOUNT,data:{fsType:e,options:n,mountPoint:r}},i)});E(this,"unmount",e=>{const n=[];return o(this,u).call(this,{type:c.UNMOUNT,data:{mountPoint:e}},n)});E(this,"readFile",(e,n="binary",{signal:r}={})=>o(this,u).call(this,{type:c.READ_FILE,data:{path:e,encoding:n}},void 0,r));E(this,"deleteFile",(e,{signal:n}={})=>o(this,u).call(this,{type:c.DELETE_FILE,data:{path:e}},void 0,n));E(this,"rename",(e,n,{signal:r}={})=>o(this,u).call(this,{type:c.RENAME,data:{oldPath:e,newPath:n}},void 0,r));E(this,"createDir",(e,{signal:n}={})=>o(this,u).call(this,{type:c.CREATE_DIR,data:{path:e}},void 0,n));E(this,"listDir",(e,{signal:n}={})=>o(this,u).call(this,{type:c.LIST_DIR,data:{path:e}},void 0,n));E(this,"deleteDir",(e,{signal:n}={})=>o(this,u).call(this,{type:c.DELETE_DIR,data:{path:e}},void 0,n))}on(e,n){e==="log"?o(this,D).push(n):e==="progress"&&o(this,O).push(n)}off(e,n){e==="log"?A(this,D,o(this,D).filter(r=>r!==n)):e==="progress"&&A(this,O,o(this,O).filter(r=>r!==n))}}R=new WeakMap,I=new WeakMap,m=new WeakMap,D=new WeakMap,O=new WeakMap,y=new WeakMap,u=new WeakMap;var S;(function(t){t.MEMFS="MEMFS",t.NODEFS="NODEFS",t.NODERAWFS="NODERAWFS",t.IDBFS="IDBFS",t.WORKERFS="WORKERFS",t.PROXYFS="PROXYFS"})(S||(S={}));const k=new Error("failed to get response body reader"),j=new Error("failed to complete download"),H="Content-Length",Y=t=>new Promise((e,n)=>{const r=new FileReader;r.onload=()=>{const{result:i}=r;i instanceof ArrayBuffer?e(new Uint8Array(i)):e(new Uint8Array)},r.onerror=i=>{var a,s;n(Error(`File could not be read! Code=${((s=(a=i==null?void 0:i.target)==null?void 0:a.error)==null?void 0:s.code)||-1}`))},r.readAsArrayBuffer(t)}),P=async t=>{let e;if(typeof t=="string")/data:_data\/([a-zA-Z]*);base64,([^"]*)/.test(t)?e=atob(t.split(",")[1]).split("").map(n=>n.charCodeAt(0)):e=await(await fetch(t)).arrayBuffer();else if(t instanceof URL)e=await(await fetch(t)).arrayBuffer();else if(t instanceof File||t instanceof Blob)e=await Y(t);else return new Uint8Array;return new Uint8Array(e)},V=async(t,e)=>{var i;const n=await fetch(t);let r;try{const a=parseInt(n.headers.get(H)||"-1"),s=(i=n.body)==null?void 0:i.getReader();if(!s)throw k;const d=[];let l=0;for(;;){const{done:L,value:U}=await s.read(),N=U?U.length:0;if(L){if(a!=-1&&a!==l)throw j;e&&e({url:t,total:a,received:l,delta:N,done:L});break}d.push(U),l+=N,e&&e({url:t,total:a,received:l,delta:N,done:L})}const f=new Uint8Array(l);let g=0;for(const L of d)f.set(L,g),g+=L.length;r=f.buffer}catch(a){console.log("failed to send download progress event: ",a),r=await n.arrayBuffer()}return r},C=async(t,e,n=!1,r)=>{const i=n?await V(t,r):await(await fetch(t)).arrayBuffer(),a=new Blob([i],{type:e});return URL.createObjectURL(a)},p=new $;p.on("log",({type:t,message:e})=>{console.log(`[FFmpeg]: ${t}: ${e}`)});const W="https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.10/dist/esm",b="https://api.fsh.plus/file?url=";(async()=>(await p.load({coreURL:await C(`${W}/ffmpeg-core.js`,"text/javascript"),wasmURL:await C(`${W}/ffmpeg-core.wasm`,"application/wasm")}),document.getElementById("loading").style.display="none"))();function h(t,e){console.log(t,e??""),document.getElementById("status").innerText=t}async function _(t){let e=document.getElementById("proxy").checked,n=await fetch(e?b+encodeURIComponent(t):t);if(n=await n.text(),n.includes("#EXT-X-STREAM-INF")){h("Playlist fetched, fetching highest quality video ...");let r=null;if(/#EXT-X-MEDIA:.*?TYPE=AUDIO/i.test(n)){let l=n.match(/^#EXT-X-MEDIA:.*?TYPE=AUDIO.*?$/gmi).sort((f,g)=>(console.log(f,g),/GROUP-ID="audio-[0-9]+?"/i.test(f)?Number(g.match(/GROUP-ID="audio-([0-9]+?)"/i)[1])-Number(f.match(/GROUP-ID="audio-([0-9]+?)"/i)[1]):0));h("Audio sources found",l),l=l[0].match(/URI="(.*?)"/)[1],l=new URL(l,t).href,r=await _(l),h("Audio fetched",l)}let i=n.match(/^#EXT-X-STREAM-INF:.+?$/gmi).map(l=>{console.log(l);let f=(l.match(/RESOLUTION=([0-9]+x[0-9]+),?/i)[1]??"1x1").split("x");return{rawres:f.join("x"),res:f[0]*f[1],band:Number(l.match(/(?:AVERAGE-BANDWIDTH|BANDWIDTH)=([0-9]+),?/i)[1])}}).sort((l,f)=>l.res===f.res?f.band-l.band:f.res-l.res);h("Video sources found",i);let a=new RegExp(`#EXT-X-STREAM-INF:.*?,?((?:AVERAGE-BANDWIDTH|BANDWIDTH)=${i[0].band}|RESOLUTION=${i[0].rawres}),?.*?`,"i"),s=n.split(`
`).findIndex(l=>l.match(a));if(s<0)throw new Error("Could not find source?",a);s=n.split(`
`)[s+1],s=new URL(s,t).href;let d=await _(s);return h("Video playlist fetched",s),{url:s,content:d.content,additional:r}}else return h("Media fetched"),{url:t,content:n,additional:null}}async function x(t){h("Fetching segments...");const e=t.url.substring(0,t.url.lastIndexOf("/")+1),n=t.content.split(`
`),r=[];let i=document.getElementById("proxy").checked;if(t.content.includes("#EXT-X-MAP:URI=")){let a=t.content.split('#EXT-X-MAP:URI="')[1].split('"')[0],s=new URL(a,e).href;h("Fetching init",s),i&&(s=b+encodeURIComponent(s)),r.push({name:a,data:await P(s)})}for(let a=0;a<n.length;a++){let s=n[a];if(s&&!s.startsWith("#")){let d=new URL(s,e).href;h(`Fetching segment ${a}...`,d),i&&(d=b+encodeURIComponent(d)),r.push({name:s,data:await P(d)})}}return r}async function K(t){let e=t.slice(1).split("/").filter(r=>r.length).slice(0,-1),n="";for(const r of e){n+="/"+r;try{await p.listDir(n)}catch{await p.createDir(n)}}}document.getElementById("convert").onclick=async function(){let t=document.getElementById("url").value;h("Fetching...");let e=await _(t),n=await x(e),r=[];e.additional&&(r=await x(e.additional));for(let{name:d,data:l}of n.concat(r)){h("Writing "+d);try{await K(d),await p.writeFile(d,l)}catch(f){h("Could not write "+d,f);return}}h("Writing playlist..."),await p.writeFile("/video.m3u8",e.content),e.additional&&await p.writeFile("/audio.m3u8",e.additional.content),h("Converting...");let i=["-allowed_extensions","ALL","-i","/video.m3u8"];e.additional?i=i.concat(["-i","/audio.m3u8","-c:v","copy","-c:a","aac"]):i=i.concat(["-c","copy"]),i=i.concat(["-bsf:a","aac_adtstoasc","output.mp4"]),await p.exec(i);const a=await p.readFile("output.mp4"),s=new Blob([a.buffer],{type:"video/mp4"});h("Done!"),document.getElementById("video").src=URL.createObjectURL(s)};
