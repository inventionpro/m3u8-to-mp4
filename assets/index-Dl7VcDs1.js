var v=Object.defineProperty;var B=t=>{throw TypeError(t)};var F=(t,e,n)=>e in t?v(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var f=(t,e,n)=>F(t,typeof e!="symbol"?e+"":e,n),T=(t,e,n)=>e.has(t)||B("Cannot "+n);var a=(t,e,n)=>(T(t,e,"read from private field"),n?n.call(t):e.get(t)),p=(t,e,n)=>e.has(t)?B("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,n),y=(t,e,n,i)=>(T(t,e,"write to private field"),i?i.call(t,n):e.set(t,n),n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&i(s)}).observe(document,{childList:!0,subtree:!0});function n(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(r){if(r.ep)return;r.ep=!0;const o=n(r);fetch(r.href,o)}})();var c;(function(t){t.LOAD="LOAD",t.EXEC="EXEC",t.FFPROBE="FFPROBE",t.WRITE_FILE="WRITE_FILE",t.READ_FILE="READ_FILE",t.DELETE_FILE="DELETE_FILE",t.RENAME="RENAME",t.CREATE_DIR="CREATE_DIR",t.LIST_DIR="LIST_DIR",t.DELETE_DIR="DELETE_DIR",t.ERROR="ERROR",t.DOWNLOAD="DOWNLOAD",t.PROGRESS="PROGRESS",t.LOG="LOG",t.MOUNT="MOUNT",t.UNMOUNT="UNMOUNT"})(c||(c={}));const M=(()=>{let t=0;return()=>t++})(),x=new Error("ffmpeg is not loaded, call `await ffmpeg.load()` first"),k=new Error("called FFmpeg.terminate()");var u,w,R,D,I,L,E;class ${constructor(){p(this,u,null);p(this,w,{});p(this,R,{});p(this,D,[]);p(this,I,[]);f(this,"loaded",!1);p(this,L,()=>{a(this,u)&&(a(this,u).onmessage=({data:{id:e,type:n,data:i}})=>{switch(n){case c.LOAD:this.loaded=!0,a(this,w)[e](i);break;case c.MOUNT:case c.UNMOUNT:case c.EXEC:case c.FFPROBE:case c.WRITE_FILE:case c.READ_FILE:case c.DELETE_FILE:case c.RENAME:case c.CREATE_DIR:case c.LIST_DIR:case c.DELETE_DIR:a(this,w)[e](i);break;case c.LOG:a(this,D).forEach(r=>r(i));break;case c.PROGRESS:a(this,I).forEach(r=>r(i));break;case c.ERROR:a(this,R)[e](i);break}delete a(this,w)[e],delete a(this,R)[e]})});p(this,E,({type:e,data:n},i=[],r)=>a(this,u)?new Promise((o,s)=>{const d=M();a(this,u)&&a(this,u).postMessage({id:d,type:e,data:n},i),a(this,w)[d]=o,a(this,R)[d]=s,r==null||r.addEventListener("abort",()=>{s(new DOMException(`Message # ${d} was aborted`,"AbortError"))},{once:!0})}):Promise.reject(x));f(this,"load",({classWorkerURL:e,...n}={},{signal:i}={})=>(a(this,u)||(y(this,u,e?new Worker(new URL(e,import.meta.url),{type:"module"}):new Worker(new URL("./worker-BAOIWoxA.js",import.meta.url),{type:"module"})),a(this,L).call(this)),a(this,E).call(this,{type:c.LOAD,data:n},void 0,i)));f(this,"exec",(e,n=-1,{signal:i}={})=>a(this,E).call(this,{type:c.EXEC,data:{args:e,timeout:n}},void 0,i));f(this,"ffprobe",(e,n=-1,{signal:i}={})=>a(this,E).call(this,{type:c.FFPROBE,data:{args:e,timeout:n}},void 0,i));f(this,"terminate",()=>{const e=Object.keys(a(this,R));for(const n of e)a(this,R)[n](k),delete a(this,R)[n],delete a(this,w)[n];a(this,u)&&(a(this,u).terminate(),y(this,u,null),this.loaded=!1)});f(this,"writeFile",(e,n,{signal:i}={})=>{const r=[];return n instanceof Uint8Array&&r.push(n.buffer),a(this,E).call(this,{type:c.WRITE_FILE,data:{path:e,data:n}},r,i)});f(this,"mount",(e,n,i)=>{const r=[];return a(this,E).call(this,{type:c.MOUNT,data:{fsType:e,options:n,mountPoint:i}},r)});f(this,"unmount",e=>{const n=[];return a(this,E).call(this,{type:c.UNMOUNT,data:{mountPoint:e}},n)});f(this,"readFile",(e,n="binary",{signal:i}={})=>a(this,E).call(this,{type:c.READ_FILE,data:{path:e,encoding:n}},void 0,i));f(this,"deleteFile",(e,{signal:n}={})=>a(this,E).call(this,{type:c.DELETE_FILE,data:{path:e}},void 0,n));f(this,"rename",(e,n,{signal:i}={})=>a(this,E).call(this,{type:c.RENAME,data:{oldPath:e,newPath:n}},void 0,i));f(this,"createDir",(e,{signal:n}={})=>a(this,E).call(this,{type:c.CREATE_DIR,data:{path:e}},void 0,n));f(this,"listDir",(e,{signal:n}={})=>a(this,E).call(this,{type:c.LIST_DIR,data:{path:e}},void 0,n));f(this,"deleteDir",(e,{signal:n}={})=>a(this,E).call(this,{type:c.DELETE_DIR,data:{path:e}},void 0,n))}on(e,n){e==="log"?a(this,D).push(n):e==="progress"&&a(this,I).push(n)}off(e,n){e==="log"?y(this,D,a(this,D).filter(i=>i!==n)):e==="progress"&&y(this,I,a(this,I).filter(i=>i!==n))}}u=new WeakMap,w=new WeakMap,R=new WeakMap,D=new WeakMap,I=new WeakMap,L=new WeakMap,E=new WeakMap;var P;(function(t){t.MEMFS="MEMFS",t.NODEFS="NODEFS",t.NODERAWFS="NODERAWFS",t.IDBFS="IDBFS",t.WORKERFS="WORKERFS",t.PROXYFS="PROXYFS"})(P||(P={}));const j=new Error("failed to get response body reader"),G=new Error("failed to complete download"),H="Content-Length",Y=t=>new Promise((e,n)=>{const i=new FileReader;i.onload=()=>{const{result:r}=i;r instanceof ArrayBuffer?e(new Uint8Array(r)):e(new Uint8Array)},i.onerror=r=>{var o,s;n(Error(`File could not be read! Code=${((s=(o=r==null?void 0:r.target)==null?void 0:o.error)==null?void 0:s.code)||-1}`))},i.readAsArrayBuffer(t)}),S=async t=>{let e;if(typeof t=="string")/data:_data\/([a-zA-Z]*);base64,([^"]*)/.test(t)?e=atob(t.split(",")[1]).split("").map(n=>n.charCodeAt(0)):e=await(await fetch(t)).arrayBuffer();else if(t instanceof URL)e=await(await fetch(t)).arrayBuffer();else if(t instanceof File||t instanceof Blob)e=await Y(t);else return new Uint8Array;return new Uint8Array(e)},K=async(t,e)=>{var r;const n=await fetch(t);let i;try{const o=parseInt(n.headers.get(H)||"-1"),s=(r=n.body)==null?void 0:r.getReader();if(!s)throw j;const d=[];let l=0;for(;;){const{done:g,value:A}=await s.read(),U=A?A.length:0;if(g){if(o!=-1&&o!==l)throw G;e&&e({url:t,total:o,received:l,delta:U,done:g});break}d.push(A),l+=U,e&&e({url:t,total:o,received:l,delta:U,done:g})}const O=new Uint8Array(l);let _=0;for(const g of d)O.set(g,_),_+=g.length;i=O.buffer}catch(o){console.log("failed to send download progress event: ",o),i=await n.arrayBuffer()}return i},W=async(t,e,n=!1,i)=>{const r=n?await K(t,i):await(await fetch(t)).arrayBuffer(),o=new Blob([r],{type:e});return URL.createObjectURL(o)},m=new $;m.on("log",({type:t,message:e})=>{console.log(`[FFmpeg]: ${t}: ${e}`)});const C="https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.10/dist/esm",b="https://api.fsh.plus/file?url=";(async()=>(await m.load({coreURL:await W(`${C}/ffmpeg-core.js`,"text/javascript"),wasmURL:await W(`${C}/ffmpeg-core.wasm`,"application/wasm")}),document.getElementById("loading").style.display="none"))();function h(t,e){console.log(t,e??""),document.getElementById("status").innerText=t}async function N(t){let e=document.getElementById("proxy").checked,n=await fetch(e?b+encodeURIComponent(t):t);if(n=await n.text(),n.includes("#EXT-X-STREAM-INF")){h("Playlist fetched, fetching highest quality video ...");let i=null;if(/#EXT-X-MEDIA:.*?TYPE=AUDIO/.test(n)){let l=n.match(/^#EXT-X-MEDIA:.*?TYPE=AUDIO.*?$/gm);l=l[0].match(/URI="(.*?)"/)[1],l=new URL(l,t).href,i=await N(l),h("Audio fetched",l)}let r=n.match(/^#EXT-X-STREAM-INF:.+?$/gm).map(l=>Number(l.match(/(?:AVERAGE-BANDWIDTH|BANDWIDTH)=([0-9])+?,?/)[1])).sort((l,O)=>O-l)[0],o=new RegExp(`#EXT-X-STREAM-INF:.*?,?(AVERAGE-BANDWIDTH|BANDWIDTH)=${r},?.*?`),s=n.split(`
`).findIndex(l=>l.match(o));if(s<0)throw new Error("Playlist without biggest bandwidth video?");s=n.split(`
`)[s+1],s=new URL(s,t).href;let d=await N(s);return h("Playlist fetched",s),{url:s,content:d.content,additional:i}}else return h("Media fetched"),{url:t,content:n,additional:null}}async function X(t){h("Fetching segments...");const e=t.url.substring(0,t.url.lastIndexOf("/")+1),n=t.content.split(`
`),i=[];let r=document.getElementById("proxy").checked;if(t.content.includes("#EXT-X-MAP:URI=")){let o=t.content.split('#EXT-X-MAP:URI="')[1].split('"')[0],s=new URL(o,e).href;h("Fetching init",s),r&&(s=b+encodeURIComponent(s)),i.push({name:o,data:await S(s)})}for(let o=0;o<n.length;o++){let s=n[o];if(s&&!s.startsWith("#")){let d=new URL(s,e).href;h(`Fetching segment ${o}...`,d),r&&(d=b+encodeURIComponent(d)),i.push({name:s,data:await S(d)})}}return i}async function q(t){let e=t.slice(1).split("/").filter(i=>i.length).slice(0,-1),n="";for(const i of e){n+="/"+i;try{await m.listDir(n)}catch{await m.createDir(n)}}}document.getElementById("convert").onclick=async function(){let t=document.getElementById("url").value;h("Fetching...");let e=await N(t),n=await X(e),i=[];e.additional&&(i=await X(e.additional));for(let{name:d,data:l}of n.concat(i)){h("Writing "+d);try{await q(d),await m.writeFile(d,l)}catch(O){h("Could not write "+d,O);return}}h("Writing playlist..."),await m.writeFile("/video.m3u8",e.content),e.additional&&await m.writeFile("/audio.m3u8",e.additional.content),h("Converting...");let r=["-allowed_extensions","ALL","-i","/video.m3u8"];e.additional?r=r.concat(["-i","/audio.m3u8","-c:v","copy","-c:a","aac"]):r=r.concat(["-c","copy"]),r=r.concat(["-bsf:a","aac_adtstoasc","output.mp4"]),await m.exec(r);const o=await m.readFile("output.mp4"),s=new Blob([o.buffer],{type:"video/mp4"});h("Done!"),document.getElementById("video").src=URL.createObjectURL(s)};
